<!DOCTYPE html>
<html lang="en" data-color-scheme="light">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Faculty Jobs • Neo UI</title>
  <style>
    /* =============================
       Neo UI — Design Tokens (2025)
       ============================= */
    :root {
      /* Palette (inspired by your previous app) */
      --color-primary: #0891b2; /* teal */
      --color-primary-600: #0e7490;
      --color-primary-700: #155e75;
      --color-bg: #fefefe;
      --color-surface: #ffffff;
      --color-elev: #f8fafc;
      --color-text: #0f172a;
      --color-text-2: #475569;
      --color-border: rgba(15, 23, 42, 0.12);
      --color-muted: rgba(2, 6, 23, 0.04);
      --color-success: #059669;
      --color-warning: #d97706;
      --color-error: #dc2626;

      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-pill: 9999px;

      --shadow-sm: 0 1px 3px rgba(2, 6, 23, 0.08), 0 1px 2px rgba(2, 6, 23, 0.04);
      --shadow-md: 0 8px 24px rgba(2, 6, 23, 0.12);
      --shadow-lg: 0 18px 40px rgba(2, 6, 23, 0.18);

      --container: 1200px;
      --space-2: 8px;  --space-3: 12px; --space-4: 16px; --space-5: 20px; --space-6: 24px; --space-8: 32px; --space-10: 40px; --space-12: 48px;
      --duration: 220ms; --ease: cubic-bezier(.16,1,.3,1);

      --gradient-hero: linear-gradient(135deg, #1e293b 0%, #334155 45%, #475569 100%);
      --gradient-card: radial-gradient(1200px 600px at 0% 0%, rgba(8,145,178,0.06), transparent 60%),
                        radial-gradient(800px 400px at 100% 0%, rgba(20,83,136,0.05), transparent 50%);
    }

    [data-color-scheme="dark"] {
      --color-bg: #0f172a;
      --color-surface: #0b1220;
      --color-elev: #111827;
      --color-text: #e5e7eb;
      --color-text-2: #93a3b8;
      --color-border: rgba(241, 245, 249, 0.12);
      --color-muted: rgba(148, 163, 184, 0.06);
      --gradient-hero: linear-gradient(135deg, #0b1220 0%, #0f172a 45%, #1f2937 100%);
      --gradient-card: radial-gradient(1000px 500px at 0% 0%, rgba(8,145,178,0.18), transparent 60%),
                        radial-gradient(800px 400px at 100% 0%, rgba(8,145,178,0.08), transparent 50%);
      color-scheme: dark;
    }

    /* Base */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--color-bg); color: var(--color-text);
      font: 15px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    a { color: var(--color-primary); text-decoration: none; }
    img { max-width: 100%; display: block; }

    .container { width: min(100%, var(--container)); margin-inline: auto; padding-inline: clamp(16px, 2vw, 24px); }
    .stack-4 > * + * { margin-top: var(--space-4); }
    .stack-6 > * + * { margin-top: var(--space-6); }

    /* Navbar */
    .navbar { position: sticky; top: 0; z-index: 40; backdrop-filter: saturate(150%) blur(8px);
      background: color-mix(in oklab, var(--color-bg) 80%, transparent);
      border-bottom: 1px solid var(--color-border);
    }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
    .brand { display: inline-flex; align-items: center; gap: 10px; }
    .brand-logo { width: 28px; height: 28px; border-radius: 8px; background: linear-gradient(135deg, #0ea5e9, var(--color-primary)); box-shadow: var(--shadow-sm); }
    .brand h1 { font-size: 18px; letter-spacing: .2px; margin: 0; }

    .nav-actions { display: flex; align-items: center; gap: 10px; }
    .chip { display: inline-flex; align-items: center; gap: 8px; padding: 6px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-pill); background: var(--color-surface); color: var(--color-text-2); }
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 10px; padding: 10px 14px; border-radius: var(--radius-md); border: 1px solid var(--color-border); background: var(--color-surface); color: var(--color-text); cursor: pointer; transition: all var(--duration) var(--ease); }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow-sm); }
    .btn.primary { background: var(--color-primary); border-color: transparent; color: white; }
    .btn.primary:hover { filter: brightness(1.02); box-shadow: 0 10px 24px rgba(8,145,178,.25); }
    .btn.ghost { background: var(--color-muted); }

    .theme-toggle { width: 38px; height: 38px; display: inline-grid; place-items: center; border-radius: 10px; border: 1px solid var(--color-border); background: var(--color-surface); }

    /* Hero */
    .hero { background: var(--gradient-hero); color: #e6faff; }
    .hero .wrap { display: grid; grid-template-columns: 1.2fr .8fr; gap: clamp(20px, 4vw, 48px); padding: clamp(28px, 8vw, 84px) 0; align-items: center; }
    .hero h2 { font-size: clamp(28px, 5vw, 46px); line-height: 1.1; margin: 0 0 12px; letter-spacing: -0.02em; }
    .hero p { color: color-mix(in oklab, white 82%, transparent); max-width: 64ch; }
    .hero-cta { display: flex; gap: 12px; margin-top: 18px; }

    .hero-card { border: 1px solid color-mix(in oklab, white 20%, transparent); background: color-mix(in oklab, white 6%, transparent); padding: 18px; border-radius: 14px; box-shadow: inset 0 1px 0 rgba(255,255,255,.06); }
    .kpi { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .kpi .box { background: color-mix(in oklab, white 8%, transparent); border: 1px solid color-mix(in oklab, white 16%, transparent); padding: 14px; border-radius: 12px; text-align: center; }
    .kpi h4 { margin: 0; font-size: 22px; }
    .kpi span { font-size: 12px; color: color-mix(in oklab, white 70%, transparent); }

    /* Sections */
    .section { padding: clamp(24px, 7vw, 64px) 0; }
    .section h3 { font-size: clamp(20px, 3vw, 28px); margin-bottom: 10px; }

    /* Filters */
    .filters { display: grid; grid-template-columns: 1.6fr repeat(3, 1fr) auto; gap: 10px; align-items: center; background: var(--color-surface); padding: 12px; border: 1px solid var(--color-border); border-radius: 14px; position: sticky; top: 64px; z-index: 30; }
    .input { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--color-border); background: var(--color-elev); color: var(--color-text); width: 100%; }
    .select { padding: 10px 12px; border-radius: 10px; border: 1px solid var(--color-border); background: var(--color-elev); color: var(--color-text); width: 100%; }

    /* Grid + Cards */
    .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .col-4 { grid-column: span 4; }
    @media (max-width: 900px) { .col-4 { grid-column: span 6; } .hero .wrap { grid-template-columns: 1fr; } .filters { grid-template-columns: 1fr 1fr; grid-auto-rows: min-content; } }
    @media (max-width: 640px) { .col-4 { grid-column: 1 / -1; } }

    .card { position: relative; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 16px; padding: 16px; box-shadow: var(--shadow-sm); overflow: clip; }
    .card::before { content: ""; position: absolute; inset: -1px; border-radius: 18px; background: linear-gradient(180deg, rgba(8,145,178,.18), transparent 30%);
      mask: linear-gradient(#000, #000) content-box, linear-gradient(#000, #000); -webkit-mask-composite: xor; mask-composite: exclude; padding: 1px; pointer-events: none; }
    .card:hover { box-shadow: var(--shadow-md); transform: translateY(-1px); }

    .job-head { display: flex; align-items: start; justify-content: space-between; gap: 10px; }
    .title { font-size: 18px; margin: 0; }
    .inst { color: var(--color-text-2); font-size: 13px; }
    .meta { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .tag { font-size: 12px; padding: 6px 10px; border: 1px solid var(--color-border); border-radius: var(--radius-pill); background: var(--color-elev); color: var(--color-text-2); }
    .desc { margin-top: 12px; color: var(--color-text-2); }
    .footer { margin-top: 14px; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .deadline { font-size: 12px; color: var(--color-text-2); }
    .deadline.urgent { color: #c2410c; font-weight: 600; }
    .status { font-size: 12px; padding: 6px 10px; border-radius: var(--radius-pill); border: 1px solid var(--color-border); }
    .status.pending { background: rgba(234, 179, 8, .12); border-color: rgba(234, 179, 8, .35); color: #a16207; }
    .status.approved { background: rgba(16, 185, 129, .12); border-color: rgba(16, 185, 129, .35); color: #047857; }

    /* Empty & skeleton */
    .empty { display: grid; place-items: center; border: 1px dashed var(--color-border); padding: 32px; border-radius: 14px; color: var(--color-text-2); background: var(--gradient-card); }
    .skeleton { position: relative; overflow: hidden; background: color-mix(in oklab, var(--color-elev) 70%, transparent); }
    .skeleton::after { content: ""; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,.25), transparent); transform: translateX(-100%); animation: shimmer 1.2s infinite; }
    @keyframes shimmer { to { transform: translateX(100%); } }

    /* Modal/Sheet */
    .modal { position: fixed; inset: 0; display: none; place-items: center; background: rgba(2,6,23,.45); z-index: 60; }
    .modal.show { display: grid; }
    .sheet { width: min(760px, 92vw); max-height: 80vh; overflow: auto; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: 18px; box-shadow: var(--shadow-lg); }
    .sheet header { display: flex; align-items: center; justify-content: space-between; padding: 14px 16px; border-bottom: 1px solid var(--color-border); }
    .sheet .body { padding: 16px; }

    /* Toasts */
    .toasts { position: fixed; top: 14px; left: 50%; transform: translateX(-50%); display: grid; gap: 8px; z-index: 70; }
    .toast { padding: 10px 14px; border-radius: 12px; border: 1px solid var(--color-border); background: var(--color-surface); box-shadow: var(--shadow-sm); }

    /* Admin chips */
    .admin-actions { display: flex; gap: 8px; }

    /* Footer */
    footer { padding: 30px 0 60px; color: var(--color-text-2); text-align: center; }
  </style>
</head>
<body>
  <div class="navbar">
    <div class="container nav-inner">
      <div class="brand">
        <div class="brand-logo" aria-hidden="true"></div>
        <h1>Faculty Jobs • Neo</h1>
      </div>
      <div class="nav-actions">
        <button class="chip" id="roleChip" title="Switch role for demo">Role: <strong id="roleName">CANDIDATE</strong></button>
        <button class="btn ghost" id="postJobBtn">Post a Job</button>
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">🌙</button>
      </div>
    </div>
  </div>

  <header class="hero">
    <div class="container wrap">
      <div>
        <h2>Find your next academic role with a friction‑free, gorgeous UI.</h2>
        <p>Search, filter, and apply across universities worldwide. Save roles, track deadlines, and—if you're admin—approve postings with one click.</p>
        <div class="hero-cta">
          <a href="#jobs" class="btn primary">Browse Jobs</a>
          <a href="#featured" class="btn">Closing Soon</a>
        </div>
      </div>
      <div class="hero-card">
        <div class="kpi">
          <div class="box"><h4 id="kpiActive">0</h4><span>Active Positions</span></div>
          <div class="box"><h4 id="kpiFeatured">0</h4><span>Closing Soon</span></div>
          <div class="box"><h4 id="kpiSaved">0</h4><span>Saved</span></div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <section id="jobs" class="section container stack-6">
      <div class="stack-4">
        <h3>Open Positions</h3>
        <div class="filters">
          <input class="input" id="q" placeholder="Search by title or institution…" />
          <select class="select" id="fDept"><option value="">All Departments</option></select>
          <select class="select" id="fLevel"><option value="">All Levels</option></select>
          <select class="select" id="fLoc"><option value="">All Locations</option></select>
          <button class="btn" id="clearFilters">Clear</button>
        </div>
      </div>
      <div id="resultsInfo" style="color:var(--color-text-2)">Loading jobs…</div>
      <div class="grid" id="grid"></div>
      <div id="emptyState" class="empty" style="display:none">No jobs matched your filters.</div>
    </section>

    <section id="featured" class="section container stack-6">
      <h3>Closing Soon</h3>
      <div class="grid" id="featuredGrid"></div>
    </section>
  </main>

  <footer>
    Built with ❤️ using your palette and improved UX patterns. Toggle role to preview CANDIDATE / EMPLOYER / ADMIN flows.
  </footer>

  <!-- Post Job Modal -->
  <div class="modal" id="postModal" role="dialog" aria-modal="true" aria-labelledby="postTitle">
    <div class="sheet">
      <header>
        <h4 id="postTitle" style="margin:0">Post a Job</h4>
        <button class="btn" id="closePost">Close</button>
      </header>
      <div class="body stack-4">
        <div class="grid" style="grid-template-columns: repeat(12,1fr); gap:12px">
          <div class="col-4" style="grid-column: span 12"><label>Title<input class="input" id="pTitle" required/></label></div>
          <div class="col-4" style="grid-column: span 6"><label>Institution<select class="select" id="pInstSel"></select></label>
<div id="pInstOtherWrap" style="display:none"><label>Institution (Other)<input class="input" id="pInstOther" /></label></div></div>
          <div class="col-4" style="grid-column: span 6"><label>Location<select class="select" id="pLocSel"></select></label>
<div id="pLocOtherWrap" style="display:none"><label>Location (Other)<input class="input" id="pLocOther" placeholder="City, State, Country"/></label></div></div>
          <div class="col-4" style="grid-column: span 6"><label>Subject(s) <small style="color:var(--color-text-2)">select multiple</small>
  <select class="select" id="pDept" multiple size="6"></select>
</label>
<div id="pDeptOtherWrap" style="display:none"><label>Other Subject(s) (comma‑separated)<input class="input" id="pDeptOther" placeholder="e.g., Oceanography, AI Safety"/></label></div></div>
          <div class="col-4" style="grid-column: span 6"><label>Position(s) <small style="color:var(--color-text-2)">select multiple</small>
  <select class="select" id="pLevel" multiple size="5"></select>
</label>
<div id="pLevelOtherWrap" style="display:none"><label>Other Position(s) (comma‑separated)<input class="input" id="pLevelOther" placeholder="e.g., Visiting Professor, Adjunct"/></label></div></div>
          <div class="col-4" style="grid-column: span 12"><label>Description<textarea class="input" id="pDesc" rows="4" required></textarea></label></div>
          <div class="col-4" style="grid-column: span 6"><label>Deadline<input class="input" id="pDead" type="date" required/></label></div>
          <div class="col-4" style="grid-column: span 6"><label>Apply Link<input class="input" id="pLink" placeholder="https://…"/></label></div>
        </div>
        <div style="display:flex; gap:10px; justify-content:flex-end">
          <button class="btn" id="submitPost">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div class="modal" id="detailsModal" role="dialog" aria-modal="true" aria-labelledby="detailsTitle">
    <div class="sheet">
      <header>
        <h4 id="detailsTitle" style="margin:0">Job Details</h4>
        <button class="btn" id="closeDetails">Close</button>
      </header>
      <div class="body" id="detailsBody"></div>
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    // =============================
    // Data (sample) + State
    // =============================
    const state = {
      role: 'CANDIDATE',
      saved: new Set(JSON.parse(localStorage.getItem('savedJobs') || '[]')),
      jobs: [
        { id:'1', title:'Assistant Professor of Computer Science', institution:'Stanford University', location:'Stanford, CA, USA', departments:['Computer Science'], levels:['Assistant Professor'], description:'Research in AI/ML; teach UG+PG; mentor students.', deadline:'2025-10-15', salaryRange:'$120k–$160k', applicationLink:'https://stanford.edu/apply', approved:true, active:true, postedBy:'employer1', createdAt:'2025-09-01' },
        { id:'2', title:'Professor of Mathematics', institution:'MIT', location:'Cambridge, MA, USA', departments:['Mathematics'], levels:['Full Professor'], description:'Tenured position; outstanding research in pure/applied math; lead initiatives.', deadline:'2025-09-20', salaryRange:'$180k–$220k', applicationLink:'https://mit.edu/faculty-search', approved:true, active:true, postedBy:'employer2', createdAt:'2025-08-28' },
        { id:'3', title:'Associate Professor of Physics', institution:'Harvard University', location:'Cambridge, MA, USA', departments:['Physics'], levels:['Associate Professor'], description:'Condensed matter/quantum materials; top facilities; global collaboration.', deadline:'2025-09-25', salaryRange:'$140k–$180k', applicationLink:'https://harvard.edu/physics-jobs', approved:true, active:true, postedBy:'employer3', createdAt:'2025-09-05' },
        { id:'4', title:'Postdoctoral Research Fellow in Biology', institution:'UC Berkeley', location:'Berkeley, CA, USA', departments:['Biology'], levels:['Postdoctoral Researcher'], description:'Computational biology + genomics; large‑scale datasets; new algorithms.', deadline:'2025-10-30', salaryRange:'$60k–$70k', applicationLink:'https://berkeley.edu/postdoc', approved:true, active:true, postedBy:'employer4', createdAt:'2025-09-10' },
        { id:'5', title:'Lecturer in Engineering', institution:'Caltech', location:'Pasadena, CA, USA', departments:['Engineering'], levels:['Lecturer'], description:'Focus on UG education in ME/EE; strong teaching preferred.', deadline:'2025-11-15', salaryRange:'$80k–$100k', applicationLink:'https://caltech.edu/jobs', approved:null, active:true, postedBy:'candidate1', createdAt:'2025-09-12' },
        { id:'7', title:'Professor of Economics (Expired)', institution:'Princeton University', location:'Princeton, NJ, USA', departments:['Economics'], levels:['Full Professor'], description:'Macroeconomics/econometrics; **closed** posting.', deadline:'2025-08-30', salaryRange:'$160k–$200k', applicationLink:'https://princeton.edu/econ', approved:true, active:false, archived:true, postedBy:'employer6', createdAt:'2025-07-15' }
      ]
    };

    // Preset dropdown lists & helpers for Post Job modal
    const SUBJECTS = ["Mathematics","Computer Science","Physics","Chemistry","Biology","Economics","Electrical Engineering","Mechanical Engineering","Civil Engineering","Management","Statistics","Data Science"]; 
    const LEVELS = ["Assistant Professor","Associate Professor","Full Professor","Lecturer","Postdoctoral Researcher","Research Scientist"]; 
    const INSTITUTIONS = ["IIT Patna","IISc Bangalore","IIT Bombay","IIT Madras","IIT Delhi","IIM Ahmedabad","MIT","Stanford University","Harvard University","UC Berkeley","Caltech","NIT Trichy"]; 
    const LOCATIONS = ["Patna, Bihar, India","Delhi, India","Mumbai, Maharashtra, India","Chennai, Tamil Nadu, India","Bengaluru, Karnataka, India","Cambridge, MA, USA","Stanford, CA, USA","Pasadena, CA, USA","Berkeley, CA, USA","Princeton, NJ, USA"]; 

    function fillSelect(id, list, includeOther=true) {
      const sel = document.getElementById(id); if (!sel) return;
      const opts = [...list.map(v => `<option value="${v}">${v}</option>`), includeOther?'<option value="__other__">Other…</option>':''].join('');
      sel.innerHTML = opts;
    }
    function attachOtherToggle(selectId, wrapId) {
      const sel = document.getElementById(selectId); const wrap = document.getElementById(wrapId);
      if (!sel || !wrap) return;
      const onChange = () => {
        const values = Array.from(sel.selectedOptions).map(o=>o.value);
        wrap.style.display = values.includes('__other__') ? '' : 'none';
      };
      sel.addEventListener('change', onChange); onChange();
    }
    function getSelectOrOther(selectId, otherId) {
      const sel = document.getElementById(selectId); const other = document.getElementById(otherId);
      if (!sel) return '';
      if (sel.value === '__other__') return (other?.value || '').trim();
      return sel.value;
    }
    function getMulti(selectId, otherId) {
      const sel = document.getElementById(selectId); const other = document.getElementById(otherId);
      const base = sel ? Array.from(sel.selectedOptions).map(o=>o.value).filter(v=>v !== '__other__') : [];
      const extra = (other?.value || '').split(',').map(s=>s.trim()).filter(Boolean);
      return [...new Set([...base, ...extra])];
    }
    function initPostDropdowns() {
      // Merge presets with values already in state
      const insts = Array.from(new Set([...INSTITUTIONS, ...state.jobs.map(j=>j.institution)]));
      const locs = Array.from(new Set([...LOCATIONS, ...state.jobs.map(j=>j.location)]));
      const subs = Array.from(new Set([...SUBJECTS, ...state.jobs.flatMap(j=>j.departments)]));
      const lvls = Array.from(new Set([...LEVELS, ...state.jobs.flatMap(j=>j.levels)]));
      fillSelect('pInstSel', insts, true);
      fillSelect('pLocSel', locs, true);
      fillSelect('pDept', subs, true);
      fillSelect('pLevel', lvls, true);
      attachOtherToggle('pInstSel','pInstOtherWrap');
      attachOtherToggle('pLocSel','pLocOtherWrap');
      attachOtherToggle('pDept','pDeptOtherWrap');
      attachOtherToggle('pLevel','pLevelOtherWrap');
      // Preselect first option for multi-selects so validation passes even if user forgets to click
      const selectFirst = (id) => { const el = document.getElementById(id); if (el && el.options.length) { el.selectedIndex = 0; } };
      selectFirst('pDept');
      selectFirst('pLevel');
    }

    // =============================
    // Utilities
    // =============================
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const fmtDate = (d) => new Date(d).toLocaleDateString();
    const daysLeft = (d) => Math.ceil((new Date(d) - new Date()) / (1000*60*60*24));

    function toast(msg) {
      const wrap = $('#toasts');
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      wrap.appendChild(t);
      setTimeout(() => { t.style.opacity = 0; t.style.transform = 'translateY(-6px)'; }, 2000);
      setTimeout(() => t.remove(), 2600);
    }

    function saveSync() {
      localStorage.setItem('savedJobs', JSON.stringify([...state.saved]));
      $('#kpiSaved').textContent = state.saved.size;
    }

    // =============================
    // Theme toggle
    // =============================
    (function initTheme(){
      const last = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-color-scheme', last);
      $('#themeToggle').textContent = last === 'dark' ? '☀️' : '🌙';
    })();

    $('#themeToggle').addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-color-scheme');
      const next = cur === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-color-scheme', next);
      localStorage.setItem('theme', next);
      $('#themeToggle').textContent = next === 'dark' ? '☀️' : '🌙';
      toast(`Switched to ${next} mode`);
    });

    // =============================
    // Role switching (demo of permissions)
    // =============================
    $('#roleChip').addEventListener('click', () => {
      state.role = state.role === 'CANDIDATE' ? 'EMPLOYER' : state.role === 'EMPLOYER' ? 'ADMIN' : 'CANDIDATE';
      $('#roleName').textContent = state.role;
      renderAll();
      toast(`Role set to ${state.role}`);
    });

    // =============================
    // Populate filters
    // =============================
    function populateFilters() {
      const depts = [...new Set(state.jobs.flatMap(j => j.departments))].sort();
      const levels = [...new Set(state.jobs.flatMap(j => j.levels))].sort();
      const locs = [...new Set(state.jobs.map(j => j.location.split(',')[1]?.trim()).filter(Boolean))].sort();

      for (const [id, arr] of Object.entries({ fDept: depts, fLevel: levels, fLoc: locs })) {
        const sel = document.getElementById(id);
        const existing = new Set([...sel.options].map(o => o.value));
        arr.forEach(v => { if (!existing.has(v)) { const o = new Option(v, v); sel.add(o); } });
      }
    }

    // =============================
    // Rendering
    // =============================
    function jobCard(j) {
      const dl = daysLeft(j.deadline);
      const expired = dl < 0 || j.archived || !j.active;
      const deadlineText = expired ? 'Expired' : (dl <= 7 ? `${dl} day${dl!==1?'s':''} left` : fmtDate(j.deadline));
      const deadlineCls = expired ? '' : (dl <= 7 ? 'deadline urgent' : 'deadline');
      const pending = j.approved === null;
      const adminControls = state.role === 'ADMIN' && pending ? `
        <div class="admin-actions">
          <button class="btn" data-approve="${j.id}">Approve</button>
          <button class="btn" data-reject="${j.id}">Reject</button>
        </div>` : '';
      const status = pending ? '<span class="status pending">Pending Approval</span>' : (j.approved ? '<span class="status approved">Approved</span>' : '');

      return `<article class="card" data-id="${j.id}">
        <div class="job-head">
          <div>
            <h4 class="title">${j.title}</h4>
            <div class="inst">${j.institution} • ${j.location}</div>
          </div>
          ${status}
        </div>
        <div class="meta">${j.departments.map(d => `<span class="tag">${d}</span>`).join('')} ${j.levels.map(l => `<span class=tag>${l}</span>`).join('')}</div>
        <p class="desc">${j.description}</p>
        <div class="footer">
          <div>
            <div class="deadline ${deadlineCls}">${deadlineText}</div>
            ${j.salaryRange ? `<div style="font-size:12px;color:var(--color-text-2)">${j.salaryRange}</div>` : ''}
          </div>
          <div style="display:flex; gap:8px; align-items:center;">
            ${j.applicationLink ? `<a class="btn" href="${j.applicationLink}" target="_blank" rel="noopener">Apply</a>` : ''}
            <button class="btn" data-details="${j.id}">Details</button>
            <button class="btn ${state.saved.has(j.id)?'primary':''}" data-save="${j.id}">${state.saved.has(j.id)?'Saved':'Save'}</button>
          </div>
        </div>
        ${adminControls}
      </article>`;
    }

    function renderJobs() {
      const grid = $('#grid');
      const q = $('#q').value.trim().toLowerCase();
      const fd = $('#fDept').value; const fl = $('#fLevel').value; const fL = $('#fLoc').value;

      let list = state.jobs.filter(j => j.active && (state.role==='ADMIN' || j.approved === true || j.__mine === true || j.postedBy === 'candidate1'));

      list = list.filter(j => (
        (!q || j.title.toLowerCase().includes(q) || j.institution.toLowerCase().includes(q)) &&
        (!fd || j.departments.includes(fd)) && (!fl || j.levels.includes(fl)) &&
        (!fL || (j.location.split(',')[1]||'').trim() === fL)
      ));

      $('#resultsInfo').textContent = `${list.length} position${list.length!==1?'s':''} found`;
      grid.innerHTML = list.length ? list.map(jobCard).join('') : '';
      $('#emptyState').style.display = list.length ? 'none' : 'block';

      // KPIs
      $('#kpiActive').textContent = state.jobs.filter(j => j.active && j.approved).length;
    }

    function renderFeatured() {
      const grid = $('#featuredGrid');
      const today = new Date();
      const soon = new Date(); soon.setDate(today.getDate()+30);
      const list = state.jobs.filter(j => j.active && j.approved && new Date(j.deadline) >= today && new Date(j.deadline) <= soon).slice(0, 6);
      grid.innerHTML = list.length ? list.map(jobCard).join('') : '<div class="empty">No featured jobs right now.</div>';
      $('#kpiFeatured').textContent = list.length;
    }

    function renderAll() { renderJobs(); renderFeatured(); populateFilters(); }

    // =============================
    // Events
    // =============================
    ['q','fDept','fLevel','fLoc'].forEach(id => document.getElementById(id).addEventListener('input', renderJobs));
    $('#clearFilters').addEventListener('click', () => { $('#q').value=''; $('#fDept').value=''; $('#fLevel').value=''; $('#fLoc').value=''; renderJobs(); });

    // Grid delegated events (save, details, admin approve/reject)
    $('#grid').addEventListener('click', (e) => {
      const save = e.target.closest('[data-save]');
      const det = e.target.closest('[data-details]');
      const ap = e.target.closest('[data-approve]');
      const rj = e.target.closest('[data-reject]');

      if (save) {
        const id = save.getAttribute('data-save');
        if (state.saved.has(id)) state.saved.delete(id); else state.saved.add(id);
        saveSync(); renderJobs(); toast(state.saved.has(id) ? 'Job saved' : 'Removed from saved');
      }
      if (det) {
        const id = det.getAttribute('data-details');
        openDetails(id);
      }
      if (ap) {
        if (state.role !== 'ADMIN') return toast('Admin only');
        const id = ap.getAttribute('data-approve');
        const j = state.jobs.find(x => x.id === id); if (j) { j.approved = true; toast('Approved'); renderAll(); }
      }
      if (rj) {
        if (state.role !== 'ADMIN') return toast('Admin only');
        const id = rj.getAttribute('data-reject');
        const j = state.jobs.find(x => x.id === id); if (j) { j.approved = false; j.active = false; toast('Rejected'); renderAll(); }
      }
    });

    // Featured grid also allows details/save
    $('#featuredGrid').addEventListener('click', (e) => {
      const det = e.target.closest('[data-details]');
      const save = e.target.closest('[data-save]');
      if (det) { openDetails(det.getAttribute('data-details')); }
      if (save) {
        const id = save.getAttribute('data-save');
        if (state.saved.has(id)) state.saved.delete(id); else state.saved.add(id);
        saveSync(); renderFeatured(); toast(state.saved.has(id) ? 'Job saved' : 'Removed from saved');
      }
    });

    // Post a job (modal)
    $('#postJobBtn').addEventListener('click', () => { initPostDropdowns(); $('#postModal').classList.add('show'); });
    $('#closePost').addEventListener('click', () => $('#postModal').classList.remove('show'));
    $('#submitPost').addEventListener('click', () => {
      const title = $('#pTitle').value.trim();
      const inst = getSelectOrOther('pInstSel','pInstOther');
      const loc  = getSelectOrOther('pLocSel','pLocOther');
      const dept = getMulti('pDept','pDeptOther');
      const level= getMulti('pLevel','pLevelOther');
      const desc = $('#pDesc').value.trim();
      const dead = $('#pDead').value.trim();
      const link = $('#pLink').value.trim();
      if (!title || !inst || !loc || !desc || !dead || dept.length===0 || level.length===0) { toast('Please complete all required fields'); return; }
      const id = String(Date.now());
      const approved = state.role === 'EMPLOYER' || state.role === 'ADMIN' ? true : null;
      const postedBy = state.role === 'CANDIDATE' ? 'candidate1' : (state.role === 'EMPLOYER' ? 'employer1' : 'admin1');
      state.jobs.unshift({ id, title, institution:inst, location:loc, departments:dept, levels:level, description:desc, deadline:dead, applicationLink:link || '', salaryRange:'', approved, active:true, postedBy, __mine:true, createdAt: new Date().toISOString().slice(0,10) });
      $('#postModal').classList.remove('show');
      ['pTitle','pInstOther','pLocOther','pDeptOther','pLevelOther','pDesc','pDead','pLink'].forEach(id => { const el = document.getElementById(id); if (el) el.value=''; });
      renderAll();
      toast(approved ? 'Job posted' : 'Submitted for approval');
    });

    // Details modal
    function openDetails(id) {
      const j = state.jobs.find(x => x.id === id); if (!j) return;
      const dl = daysLeft(j.deadline);
      $('#detailsBody').innerHTML = `
        <div class="stack-4">
          <div style="display:flex; justify-content:space-between; align-items:start; gap:16px">
            <div>
              <h3 style="margin:.2rem 0">${j.title}</h3>
              <div style="color:var(--color-text-2)">${j.institution} • ${j.location}</div>
            </div>
            ${j.approved===null?'<span class="status pending">Pending Approval</span>':''}
          </div>
          <div class="meta">${j.departments.map(d => `<span class=tag>${d}</span>`).join('')} ${j.levels.map(l => `<span class=tag>${l}</span>`).join('')}</div>
          <p>${j.description}</p>
          <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
            <div class="deadline ${dl<=7 && dl>=0 ? 'urgent':''}">${dl<0?'Expired':`Deadline: ${fmtDate(j.deadline)} (${dl} day${dl!==1?'s':''} left)`}</div>
            <div style="display:flex; gap:8px">
              ${j.applicationLink?`<a class="btn" href="${j.applicationLink}" target="_blank" rel="noopener">Apply</a>`:''}
              <button class="btn" data-save="${j.id}">${state.saved.has(j.id)?'Saved':'Save'}</button>
            </div>
          </div>
        </div>`;
      $('#detailsModal').classList.add('show');
    }
    $('#closeDetails').addEventListener('click', () => $('#detailsModal').classList.remove('show'));

    // =============================
    // Lightweight self-tests (non‑mutating)
    // =============================
    function runSelfTests() {
      const results = [];
      try { results.push({name:'util:daysLeft', pass: typeof daysLeft('2099-01-01') === 'number' }); } catch(e){ results.push({name:'util:daysLeft', pass:false, e}); }
      try { const html = jobCard(state.jobs[0]); results.push({name:'render:jobCard', pass: typeof html === 'string' && html.includes('article')}); } catch(e){ results.push({name:'render:jobCard', pass:false, e}); }
      try {
        // test getMulti using a detached select
        const sel = document.createElement('select'); sel.multiple = true; sel.innerHTML = '<option value="A" selected>A</option><option value="__other__" selected>Other…</option>';
        const input = document.createElement('input'); input.value = 'B, C';
        document.body.appendChild(sel); document.body.appendChild(input);
        const vals = (function(){
          const idSel = 'tmpSel'; const idOther = 'tmpOther'; sel.id=idSel; input.id=idOther; return getMulti(idSel,idOther);
        })();
        document.body.removeChild(sel); document.body.removeChild(input);
        results.push({name:'util:getMulti', pass: Array.isArray(vals) && vals.includes('A') && vals.includes('B') && vals.includes('C')});
      } catch(e){ results.push({name:'util:getMulti', pass:false, e}); }
      const failed = results.filter(r=>!r.pass);
      if (failed.length){ console.warn('Self‑tests failed', results); toast('⚠️ Self‑tests failed (see console)'); } else { console.log('Self‑tests passed', results); }
    }

    // Init
    populateFilters();
    renderAll();
    saveSync();
    runSelfTests();
  </script>
</body>
</html>
